extends: [autotools_package]
dependencies:
  build: [blas]
  run: [blas]

sources:
  - url: http://faculty.cse.tamu.edu/davis/SuiteSparse/SuiteSparse-4.4.6.tar.gz
    key: tar.gz:p4rfbhmhvwufazma2u367xtzz6iofdrc

build_stages:
  - name: configure
    mode: replace
    after: prologue
    handler: bash
    bash: |
      cat > SuiteSparse_config/SuiteSparse_config.mk << EOF
      #CF = \$(CFLAGS) \$(CPPFLAGS) \$(TARGET_ARCH) -O3 -fexceptions -fPIC
      CF = \$(CFLAGS) \$(CPPFLAGS) \$(TARGET_ARCH) -O3 -fexceptions -fPIC -DNTIMER
      RANLIB = ranlib
      ARCHIVE = \$(AR) \$(ARFLAGS)
      CP = cp -f
      MV = mv -f
      F77 = gfortran
      F77FLAGS = \$(FFLAGS) -O
      F77LIB =
      #LIB = -lm -lrt
      LIB = -lm
      INSTALL_LIB = ${ARTIFACT}/lib
      INSTALL_INCLUDE = ${ARTIFACT}/include/suitesparse
      XERBLA =
      BLAS = ${BLAS_LDFLAGS}
      LAPACK = \$(BLAS)
      GPU_BLAS_PATH =
      GPU_CONFIG =
      UMFPACK_CONFIG =
      CHOLMOD_CONFIG = \$(GPU_CONFIG) -DNPARTITION
      SPQR_CONFIG =
      TBB =
      CLEAN = *.o *.obj *.ln *.bb *.bbg *.da *.tcov *.gcov gmon.out *.bak *.d *.gcda *.gcno
      EOF
      cat > Makefile << EOF
      #-------------------------------------------------------------------------------
      # Makefile for all SuiteSparse packages
      #-------------------------------------------------------------------------------
      include SuiteSparse_config/SuiteSparse_config.mk
      # install all packages in /usr/local/lib and /usr/local/include
      # (note that CSparse is not installed; CXSparse is installed instead)
      install:
	      ( cd SuiteSparse_config && $(MAKE) install )
	      ( cd AMD && $(MAKE) install )
	      ( cd CAMD && $(MAKE) install )
	      ( cd COLAMD && $(MAKE) install )
	      ( cd BTF && $(MAKE) install 
	      ( cd KLU && $(MAKE) install )
	      ( cd LDL && $(MAKE) install )
	      ( cd CCOLAMD && $(MAKE) install )
	      ( cd UMFPACK && $(MAKE) install )
	      ( cd CHOLMOD && $(MAKE) install )
	      ( cd CXSparse && $(MAKE) install )
	      ( cd RBio && $(MAKE) install )
      ifneq ($(GPU_CONFIG),)
	      ( cd SuiteSparse_GPURuntime && $(MAKE) install )
	      ( cd GPUQREngine && $(MAKE) install )
     endif
	    ( cd SPQR && $(MAKE) install )
     # uninstall all packages
     uninstall:
	    ( cd SuiteSparse_config && $(MAKE) uninstall )
	    ( cd AMD && $(MAKE) uninstall )
	    ( cd CAMD && $(MAKE) uninstall )
	    ( cd COLAMD && $(MAKE) uninstall )
	    ( cd BTF && $(MAKE) uninstall )
	    ( cd KLU && $(MAKE) uninstall )
	    ( cd LDL && $(MAKE) uninstall )
	    ( cd CCOLAMD && $(MAKE) uninstall )
	    ( cd UMFPACK && $(MAKE) uninstall )
	    ( cd CHOLMOD && $(MAKE) uninstall )
	    ( cd CXSparse && $(MAKE) uninstall )
	    ( cd RBio && $(MAKE) uninstall )
	    ( cd SuiteSparse_GPURuntime && $(MAKE) uninstall )
	    ( cd GPUQREngine && $(MAKE) uninstall )
	    ( cd SPQR && $(MAKE) uninstall )
     default:
	    ( cd SuiteSparse_config/xerbla && $(MAKE) )
	    ( cd SuiteSparse_config && $(MAKE) )
	    - ( cd metis-4.0 && $(MAKE) )
	    ( cd AMD && $(MAKE) library )
	    ( cd BTF && $(MAKE) library )
	    ( cd CAMD && $(MAKE) library )
	    ( cd CCOLAMD && $(MAKE) library )
	    ( cd COLAMD && $(MAKE) library )
	    ( cd CHOLMOD && $(MAKE) library )
	    ( cd KLU && $(MAKE) library )
	    ( cd LDL && $(MAKE) library )
	    ( cd UMFPACK && $(MAKE) library )
	    ( cd CSparse && $(MAKE) library )
	    ( cd CXSparse && $(MAKE) library )
	    ( cd RBio && $(MAKE) library )
     ifneq ($(GPU_CONFIG),)
	    ( cd SuiteSparse_GPURuntime && $(MAKE) library )
	    ( cd GPUQREngine && $(MAKE) library )
     endif
	    ( cd SPQR && $(MAKE) library )
     # Remove all files not in the original distribution
     purge:
	    - ( cd SuiteSparse_config/xerbla && $(MAKE) purge )
	    - ( cd SuiteSparse_config && $(MAKE) purge )
	    - ( cd metis-4.0 && $(MAKE) realclean )
	    - ( cd AMD && $(MAKE) purge )
	    - ( cd CAMD && $(MAKE) purge )
	    - ( cd COLAMD && $(MAKE) purge )
	    - ( cd BTF && $(MAKE) purge )
	    - ( cd KLU && $(MAKE) purge )
	    - ( cd LDL && $(MAKE) purge )
	    - ( cd CCOLAMD && $(MAKE) purge )
	    - ( cd UMFPACK && $(MAKE) purge )
	    - ( cd CHOLMOD && $(MAKE) purge )
	    - ( cd CSparse && $(MAKE) purge )
	    - ( cd CXSparse && $(MAKE) purge )
      - ( cd RBio && $(MAKE) purge )
      - ( cd MATLAB_Tools/UFcollection && $(RM) *.mex* )
      - ( cd MATLAB_Tools/SSMULT && $(RM) *.mex* )
      - ( cd SuiteSparse_GPURuntime && $(MAKE) purge )
      - ( cd GPUQREngine && $(MAKE) purge )
      - ( cd SPQR && $(MAKE) purge )
      - $(RM) MATLAB_Tools/*/*.mex* MATLAB_Tools/spok/private/*.mex*
     # Remove all files not in the original distribution, but keep the libraries
     clean:
      - ( cd SuiteSparse_config/xerbla && $(MAKE) clean )
      - ( cd SuiteSparse_config && $(MAKE) clean )
      - ( cd metis-4.0 && $(MAKE) clean )
      - ( cd AMD && $(MAKE) clean )
      - ( cd CAMD && $(MAKE) clean )
      - ( cd COLAMD && $(MAKE) clean )
      - ( cd BTF && $(MAKE) clean )
      - ( cd KLU && $(MAKE) clean )
      - ( cd LDL && $(MAKE) clean )
      - ( cd CCOLAMD && $(MAKE) clean )
      - ( cd UMFPACK && $(MAKE) clean )
      - ( cd CHOLMOD && $(MAKE) clean )
      - ( cd CSparse && $(MAKE) clean )
      - ( cd CXSparse && $(MAKE) clean )
      - ( cd RBio && $(MAKE) clean )
      - ( cd SuiteSparse_GPURuntime && $(MAKE) clean )
      - ( cd GPUQREngine && $(MAKE) clean )
      - ( cd SPQR && $(MAKE) clean )
     distclean: purge
     EOF


  - name: create-install-directories
    before: install
    handler: bash
    bash: |
      mkdir -p ${ARTIFACT}/include/suitesparse
      mkdir -p ${ARTIFACT}/lib
